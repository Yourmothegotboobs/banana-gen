{% extends "base_new.html" %}

{% block title %}图片来源管理 - Banana Gen Web UI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-image text-primary"></i>
                图片来源管理
            </h2>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-upload"></i> 上传图片
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 图片来源类型 -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="bi bi-file-image text-primary" style="font-size: 3rem;"></i>
                </div>
                <h5 class="card-title">本地图片</h5>
                <p class="card-text">上传本地图片文件</p>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-upload"></i> 上传
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="bi bi-link-45deg text-success" style="font-size: 3rem;"></i>
                </div>
                <h5 class="card-title">网络图片</h5>
                <p class="card-text">使用网络图片链接</p>
                <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#urlModal">
                    <i class="bi bi-link"></i> 添加URL
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="bi bi-folder text-info" style="font-size: 3rem;"></i>
                </div>
                <h5 class="card-title">文件夹</h5>
                <p class="card-text">选择本地图片文件夹</p>
                <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#folderModal">
                    <i class="bi bi-folder"></i> 选择文件夹
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="bi bi-folder2-open text-warning" style="font-size: 3rem;"></i>
                </div>
                <h5 class="card-title">递归文件夹</h5>
                <p class="card-text">包含子目录的文件夹</p>
                <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#recursiveModal">
                    <i class="bi bi-folder2-open"></i> 选择递归文件夹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 已配置的图片来源 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list"></i>
                    已配置的图片来源
                </h5>
            </div>
            <div class="card-body">
                <div id="sources-list">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox"></i>
                        暂无配置的图片来源
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 上传图片模态框 -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-upload"></i>
                    上传图片
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="upload-form">
                    <div class="mb-3">
                        <label class="form-label">选择图片文件</label>
                        <input type="file" class="form-control" id="image-file" accept="image/*" multiple>
                        <div class="form-text">支持 PNG, JPG, JPEG, GIF, BMP, WEBP 格式</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">图片预览</label>
                        <div id="image-preview" class="border rounded p-3" style="min-height: 100px;">
                            <div class="text-center text-muted">
                                <i class="bi bi-image"></i>
                                选择文件后显示预览
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="uploadImages()">
                    <i class="bi bi-upload"></i> 上传
                </button>
            </div>
        </div>
    </div>
</div>

<!-- URL 图片模态框 -->
<div class="modal fade" id="urlModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-link"></i>
                    添加网络图片
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="url-form">
                    <div class="mb-3">
                        <label class="form-label">图片URL</label>
                        <input type="url" class="form-control" id="image-url" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备用URL（可选）</label>
                        <input type="url" class="form-control" id="fallback-urls" placeholder="https://backup.com/image.jpg">
                        <div class="form-text">多个URL用逗号分隔</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">图片预览</label>
                        <div id="url-preview" class="border rounded p-3" style="min-height: 100px;">
                            <div class="text-center text-muted">
                                <i class="bi bi-image"></i>
                                输入URL后显示预览
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="addUrlImage()">
                    <i class="bi bi-plus"></i> 添加
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 文件夹选择模态框 -->
<div class="modal fade" id="folderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-folder"></i>
                    选择文件夹
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="folder-form">
                    <div class="mb-3">
                        <label class="form-label">文件夹路径</label>
                        <input type="text" class="form-control" id="folder-path" placeholder="/path/to/images">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备用路径（可选）</label>
                        <input type="text" class="form-control" id="fallback-paths" placeholder="/path/to/backup">
                        <div class="form-text">多个路径用逗号分隔</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">文件夹预览</label>
                        <div id="folder-preview" class="border rounded p-3" style="min-height: 100px;">
                            <div class="text-center text-muted">
                                <i class="bi bi-folder"></i>
                                输入路径后显示预览
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info" onclick="addFolder()">
                    <i class="bi bi-plus"></i> 添加
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 递归文件夹选择模态框 -->
<div class="modal fade" id="recursiveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-folder2-open"></i>
                    选择递归文件夹
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recursive-form">
                    <div class="mb-3">
                        <label class="form-label">递归文件夹路径</label>
                        <input type="text" class="form-control" id="recursive-path" placeholder="/path/to/images">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备用路径（可选）</label>
                        <input type="text" class="form-control" id="recursive-fallback" placeholder="/path/to/backup">
                        <div class="form-text">多个路径用逗号分隔</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">文件夹预览</label>
                        <div id="recursive-preview" class="border rounded p-3" style="min-height: 100px;">
                            <div class="text-center text-muted">
                                <i class="bi bi-folder2-open"></i>
                                输入路径后显示预览
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" onclick="addRecursiveFolder()">
                    <i class="bi bi-plus"></i> 添加
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let configuredSources = [];
    
    // 图片文件预览
    document.getElementById('image-file').addEventListener('change', function(e) {
        const files = e.target.files;
        const preview = document.getElementById('image-preview');
        
        if (files.length === 0) {
            preview.innerHTML = '<div class="text-center text-muted"><i class="bi bi-image"></i> 选择文件后显示预览</div>';
            return;
        }
        
        preview.innerHTML = '';
        Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-preview me-2 mb-2';
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.title = file.name;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
    });
    
    // URL 图片预览
    document.getElementById('image-url').addEventListener('input', function(e) {
        const url = e.target.value;
        const preview = document.getElementById('url-preview');
        
        if (!url) {
            preview.innerHTML = '<div class="text-center text-muted"><i class="bi bi-image"></i> 输入URL后显示预览</div>';
            return;
        }
        
        preview.innerHTML = `<img src="${url}" class="image-preview" style="max-width: 100%; max-height: 200px;" onerror="this.parentElement.innerHTML='<div class=\'text-center text-danger\'><i class=\'bi bi-exclamation-triangle\'></i> 无法加载图片</div>'">`;
    });
    
    // 文件夹预览
    document.getElementById('folder-path').addEventListener('input', function(e) {
        const path = e.target.value;
        const preview = document.getElementById('folder-preview');
        
        if (!path) {
            preview.innerHTML = '<div class="text-center text-muted"><i class="bi bi-folder"></i> 输入路径后显示预览</div>';
            return;
        }
        
        // 这里可以添加文件夹内容预览逻辑
        preview.innerHTML = `<div class="text-center text-info"><i class="bi bi-folder"></i> 文件夹: ${path}</div>`;
    });
    
    // 递归文件夹预览
    document.getElementById('recursive-path').addEventListener('input', function(e) {
        const path = e.target.value;
        const preview = document.getElementById('recursive-preview');
        
        if (!path) {
            preview.innerHTML = '<div class="text-center text-muted"><i class="bi bi-folder2-open"></i> 输入路径后显示预览</div>';
            return;
        }
        
        preview.innerHTML = `<div class="text-center text-warning"><i class="bi bi-folder2-open"></i> 递归文件夹: ${path}</div>`;
    });
    
    // 上传图片
    function uploadImages() {
        const files = document.getElementById('image-file').files;
        if (files.length === 0) {
            showMessage('请选择要上传的图片文件', 'warning');
            return;
        }
        
        const formData = new FormData();
        Array.from(files).forEach(file => {
            formData.append('file', file);
        });
        
        fetch('/api/sources/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('图片上传成功', 'success');
                addSourceToList({
                    type: 'local_image',
                    path: data.path,
                    name: data.filename
                });
                bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            } else {
                showMessage(data.error, 'danger');
            }
        })
        .catch(error => {
            showMessage('上传失败: ' + error.message, 'danger');
        });
    }
    
    // 添加URL图片
    function addUrlImage() {
        const url = document.getElementById('image-url').value;
        const fallbackUrls = document.getElementById('fallback-urls').value;
        
        if (!url) {
            showMessage('请输入图片URL', 'warning');
            return;
        }
        
        addSourceToList({
            type: 'url_image',
            path: url,
            fallback_urls: fallbackUrls ? fallbackUrls.split(',').map(s => s.trim()) : []
        });
        
        bootstrap.Modal.getInstance(document.getElementById('urlModal')).hide();
        showMessage('URL图片已添加', 'success');
    }
    
    // 添加文件夹
    function addFolder() {
        const path = document.getElementById('folder-path').value;
        const fallbackPaths = document.getElementById('fallback-paths').value;
        
        if (!path) {
            showMessage('请输入文件夹路径', 'warning');
            return;
        }
        
        addSourceToList({
            type: 'folder',
            path: path,
            fallback_paths: fallbackPaths ? fallbackPaths.split(',').map(s => s.trim()) : []
        });
        
        bootstrap.Modal.getInstance(document.getElementById('folderModal')).hide();
        showMessage('文件夹已添加', 'success');
    }
    
    // 添加递归文件夹
    function addRecursiveFolder() {
        const path = document.getElementById('recursive-path').value;
        const fallbackPaths = document.getElementById('recursive-fallback').value;
        
        if (!path) {
            showMessage('请输入递归文件夹路径', 'warning');
            return;
        }
        
        addSourceToList({
            type: 'recursive_folder',
            path: path,
            fallback_paths: fallbackPaths ? fallbackPaths.split(',').map(s => s.trim()) : []
        });
        
        bootstrap.Modal.getInstance(document.getElementById('recursiveModal')).hide();
        showMessage('递归文件夹已添加', 'success');
    }
    
    // 添加到来源列表
    function addSourceToList(source) {
        configuredSources.push(source);
        updateSourcesList();
    }
    
    // 更新来源列表显示
    function updateSourcesList() {
        const container = document.getElementById('sources-list');
        
        if (configuredSources.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-inbox"></i> 暂无配置的图片来源</div>';
            return;
        }
        
        container.innerHTML = configuredSources.map((source, index) => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-1">
                            <i class="bi ${getSourceIcon(source.type)} text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-1">${getSourceTypeName(source.type)}</h6>
                            <p class="mb-0 text-muted">${source.path}</p>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-secondary">${source.type}</span>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="removeSource(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // 获取来源类型图标
    function getSourceIcon(type) {
        const icons = {
            'local_image': 'bi-file-image',
            'url_image': 'bi-link-45deg',
            'folder': 'bi-folder',
            'recursive_folder': 'bi-folder2-open'
        };
        return icons[type] || 'bi-question-circle';
    }
    
    // 获取来源类型名称
    function getSourceTypeName(type) {
        const names = {
            'local_image': '本地图片',
            'url_image': '网络图片',
            'folder': '文件夹',
            'recursive_folder': '递归文件夹'
        };
        return names[type] || type;
    }
    
    // 移除来源
    function removeSource(index) {
        configuredSources.splice(index, 1);
        updateSourcesList();
        showMessage('图片来源已移除', 'info');
    }
    
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        updateSourcesList();
    });
</script>
{% endblock %}
