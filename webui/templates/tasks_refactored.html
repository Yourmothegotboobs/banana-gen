{% extends "base_refactored.html" %}

{% block title %}任务管理 - Banana Gen Web UI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-play-circle text-primary"></i>
                任务管理
            </h2>
            <div>
                <span class="badge bg-primary me-2" id="task-count">0 个任务</span>
                <span class="badge bg-success" id="system-status-badge">系统正常</span>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle"></i>
                    创建新任务
                </h5>
            </div>
            <div class="card-body">
                <form id="task-form">
                    <!-- 图片来源配置 -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-image"></i>
                            图片来源配置
                        </h6>
                        <div id="input-sources">
                            <div class="input-source-item mb-3 p-3 border rounded">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <select class="form-select source-type" name="source_type">
                                            <option value="local_image">本地图片</option>
                                            <option value="url_image">网络图片</option>
                                            <option value="folder">文件夹</option>
                                            <option value="recursive_folder">递归文件夹</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control source-path" placeholder="输入路径或URL">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="browseFolder(this)">
                                            <i class="bi bi-folder"></i> 浏览
                                        </button>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeSource(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="addSource()">
                            <i class="bi bi-plus"></i> 添加图片来源
                        </button>
                    </div>
                    
                    <!-- Prompt 选择 -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-chat-text"></i>
                            Prompt 选择
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-select" id="prompt-select" multiple>
                                    {% for prompt in prompts %}
                                    <option value="{{ prompt.id }}">{{ prompt.id }} ({{ prompt.input_count }} 输入图)</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">按住 Ctrl 选择多个 Prompt</small>
                            </div>
                            <div class="col-md-6">
                                <!-- 全局生成张数 -->
                                <label class="form-label">每个 Prompt 生成张数</label>
                                <input type="number" class="form-control" id="repeat-count" value="1" min="1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 选中 Prompt 文本编辑区（每个 Prompt 独立显示） -->
                    <div class="mb-4" id="selected-prompts-editor" style="display:none;">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-pencil-square"></i>
                            编辑选中 Prompt 文本
                        </h6>
                        <div id="prompt-editors" class="vstack gap-3"></div>
                    </div>
                    
                    <!-- 字符串替换 -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-arrow-repeat"></i>
                            字符串替换规则
                        </h6>
                        <div id="replacement-rules">
                            <div class="replacement-rule mb-3 p-3 border rounded">
                                <div class="row g-2">
                                    <div class="col-md-2">
                                        <input type="text" class="form-control form-control-sm" placeholder="基础字符串">
                                    </div>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control form-control-sm" placeholder="替换选项，用逗号分隔">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeReplacement(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="addReplacement()">
                            <i class="bi bi-plus"></i> 添加替换规则
                        </button>
                    </div>
                    
                    <!-- 输出配置 -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-folder"></i>
                            输出配置
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">输出目录</label>
                                <input type="text" class="form-control" id="output-dir" value="webui/outputs">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">基础名称</label>
                                <input type="text" class="form-control" id="base-name" value="webui_task">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 提交按钮 -->
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="previewTask()">
                            <i class="bi bi-eye"></i> 预览任务
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-play-circle"></i> 创建并执行任务
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <!-- 任务状态 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-activity"></i>
                    任务状态
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-primary" id="total-tasks">0</div>
                            <small class="text-muted">总任务数</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-success" id="completed-tasks">0</div>
                            <small class="text-muted">已完成</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-danger" id="failed-tasks">0</div>
                            <small class="text-muted">失败</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-info" id="progress-percent">0%</div>
                            <small class="text-muted">进度</small>
                        </div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 10px;">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- 预览结果 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-eye"></i>
                    预览结果
                </h5>
            </div>
            <div class="card-body" id="preview-panel">
                <div class="text-muted">点击“预览任务”来查看预计任务数量。</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 自定义 Prompt 编辑：根据选择加载并展示编辑器
    document.getElementById('prompt-select').addEventListener('change', refreshPromptEditors);

    function refreshPromptEditors() {
        const selected = Array.from(document.getElementById('prompt-select').selectedOptions).map(o => o.value);
        const container = document.getElementById('prompt-editors');
        const wrapper = document.getElementById('selected-prompts-editor');
        container.innerHTML = '';
        if (selected.length === 0) {
            wrapper.style.display = 'none';
            return;
        }
        wrapper.style.display = 'block';
        // 为每个选中 prompt 拉取并生成一个独立编辑区
        selected.forEach(pid => {
            fetch(`/api/prompts/${pid}`)
                .then(r => r.json())
                .then(data => {
                    if (data && !data.error) {
                        const block = document.createElement('div');
                        block.className = 'p-3 border rounded';
                        block.innerHTML = `
                            <label class="form-label fw-bold">${data.id}</label>
                            <textarea class="form-control prompt-textarea" data-prompt-id="${data.id}" rows="3">${data.text}</textarea>
                        `;
                        container.appendChild(block);
                    }
                })
                .catch(() => {});
        });
    }

    // 表单提交
    document.getElementById('task-form').addEventListener('submit', function(e) {
        e.preventDefault();
        createTask();
    });

    function addSource() {
        const container = document.getElementById('input-sources');
        const newSource = document.querySelector('.input-source-item').cloneNode(true);
        newSource.querySelector('.source-path').value = '';
        container.appendChild(newSource);
    }

    function removeSource(button) {
        if (document.querySelectorAll('.input-source-item').length > 1) {
            button.closest('.input-source-item').remove();
        }
    }

    function browseFolder(button) {
        const input = button.closest('.input-source-item').querySelector('.source-path');
        const type = button.closest('.input-source-item').querySelector('.source-type').value;
        if (type === 'folder' || type === 'recursive_folder') {
            input.value = prompt('请输入文件夹路径:');
        }
    }

    function addReplacement() {
        const container = document.getElementById('replacement-rules');
        const newRule = document.querySelector('.replacement-rule').cloneNode(true);
        newRule.querySelectorAll('input').forEach(input => input.value = '');
        container.appendChild(newRule);
    }

    function removeReplacement(button) {
        if (document.querySelectorAll('.replacement-rule').length > 1) {
            button.closest('.replacement-rule').remove();
        }
    }

    function collectStringReplaceList() {
        const list = [];
        document.querySelectorAll('.replacement-rule').forEach(rule => {
            const baseString = rule.querySelector('input[placeholder="基础字符串"]').value;
            const replacements = rule.querySelector('input[placeholder="替换选项，用逗号分隔"]').value;
            if (baseString || replacements) {
                const arr = [baseString || ''];
                if (replacements) {
                    arr.push(...replacements.split(',').map(s => s.trim()));
                }
                list.push(arr);
            }
        });
        return list;
    }

    function collectCustomPrompts() {
        const items = [];
        document.querySelectorAll('.prompt-textarea').forEach(area => {
            items.push({ id: area.getAttribute('data-prompt-id'), text: area.value });
        });
        return items;
    }

    function collectInputSources() {
        const inputSources = [];
        document.querySelectorAll('.input-source-item').forEach(item => {
            const type = item.querySelector('.source-type').value;
            const path = item.querySelector('.source-path').value;
            if (path) {
                inputSources.push({ type: type, path: path });
            }
        });
        return inputSources;
    }

    // 创建任务
    function createTask() {
        const form = document.getElementById('task-form');
        const submitBtn = form.querySelector('button[type="submit"]');

        const promptIds = Array.from(document.getElementById('prompt-select').selectedOptions).map(option => option.value);
        const taskData = {
            input_sources: collectInputSources(),
            prompt_ids: promptIds,
            custom_prompts: collectCustomPrompts(),
            string_replace_list: collectStringReplaceList(),
            output_dir: document.getElementById('output-dir').value,
            base_name: document.getElementById('base-name').value,
            repeat_per_prompt: parseInt(document.getElementById('repeat-count').value || '1', 10)
        };

        setLoading(submitBtn, true);
        fetch('/api/tasks/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                updateTaskCount(data.task_count);
                startTask();
            } else {
                showMessage(data.error, 'danger');
            }
        })
        .catch(error => {
            showMessage('创建任务失败: ' + error.message, 'danger');
        })
        .finally(() => {
            setLoading(submitBtn, false);
        });
    }

    // 预览任务（仅统计）
    function previewTask() {
        const previewBtn = document.querySelector('button.btn.btn-outline-secondary');
        setLoading(previewBtn, true);
        const payload = {
            input_sources: collectInputSources(),
            prompt_ids: Array.from(document.getElementById('prompt-select').selectedOptions).map(option => option.value),
            custom_prompts: collectCustomPrompts(),
            string_replace_list: collectStringReplaceList(),
            repeat_per_prompt: parseInt(document.getElementById('repeat-count').value || '1', 10)
        };
        fetch('/api/tasks/preview', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => {
            const panel = document.getElementById('preview-panel');
            if (data && data.success) {
                panel.innerHTML = `
                    <div class="row g-3">
                        <div class="col-4 text-center">
                            <div class="h4 text-primary">${data.estimated_tasks}</div>
                            <small class="text-muted">预计任务数</small>
                        </div>
                        <div class="col-4 text-center">
                            <div class="h4 text-success">${data.prompt_count}</div>
                            <small class="text-muted">Prompt 数</small>
                        </div>
                        <div class="col-4 text-center">
                            <div class="h4 text-info">${data.replace_combinations}</div>
                            <small class="text-muted">替换组合</small>
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = `<div class="text-danger">${(data && data.error) || '预览失败'}</div>`;
            }
        })
        .catch(err => {
            document.getElementById('preview-panel').innerHTML = `<div class="text-danger">预览失败: ${err.message}</div>`;
        })
        .finally(() => setLoading(previewBtn, false));
    }

    function startTask() {
        fetch('/api/tasks/start', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('任务已开始执行', 'success');
                startStatusMonitoring();
            } else {
                showMessage(data.error, 'danger');
            }
        })
        .catch(error => {
            showMessage('启动任务失败: ' + error.message, 'danger');
        });
    }

    function updateTaskCount(count) {
        document.getElementById('task-count').textContent = count + ' 个任务';
    }

    function startStatusMonitoring() {
        const interval = setInterval(() => {
            fetch('/api/tasks/status')
                .then(response => response.json())
                .then(data => {
                    updateTaskStatus(data);
                    if (!data.running) {
                        clearInterval(interval);
                    }
                })
                .catch(error => { console.error('获取状态失败:', error); });
        }, 2000);
    }

    function updateTaskStatus(data) {
        const stats = data.stats || {};
        const total = stats.total_tasks || 0;
        const completed = stats.completed_tasks || 0;
        const failed = stats.failed_tasks || 0;
        const progress = total > 0 ? Math.round((completed + failed) / total * 100) : 0;
        document.getElementById('total-tasks').textContent = total;
        document.getElementById('completed-tasks').textContent = completed;
        document.getElementById('failed-tasks').textContent = failed;
        document.getElementById('progress-percent').textContent = progress + '%';
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = progress + '%';
        progressBar.className = 'progress-bar ' + (progress === 100 ? 'bg-success' : 'bg-primary');
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/tasks/status')
            .then(response => response.json())
            .then(data => { updateTaskStatus(data); })
            .catch(error => { console.error('获取初始状态失败:', error); });
    });
</script>
{% endblock %}
