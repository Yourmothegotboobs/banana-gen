{% extends "base.html" %}

{% block title %}æ—¥å¿—æŸ¥çœ‹ - Banana Gen Web UI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-file-text-fill text-secondary"></i>
                æ—¥å¿—æŸ¥çœ‹
            </h2>
            <div>
                <button class="btn btn-outline-secondary me-2" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i>
                    åˆ·æ–°
                </button>
                <button class="btn btn-secondary" onclick="clearLogs()">
                    <i class="bi bi-trash"></i>
                    æ¸…ç©ºæ—¥å¿—
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ—¥å¿—æ–‡ä»¶åˆ—è¡¨ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i>
                    æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
                </h5>
            </div>
            <div class="card-body">
                {% if log_files %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>æ–‡ä»¶å</th>
                                <th>ç±»å‹</th>
                                <th>å¤§å°</th>
                                <th>ä¿®æ”¹æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log_file in log_files %}
                            <tr>
                                <td>
                                    <i class="bi bi-{% if log_file.filename.endswith('.jsonl') %}file-text{% else %}file-earmark-text{% endif %} text-primary"></i>
                                    {{ log_file.filename }}
                                </td>
                                <td>
                                    <span class="badge bg-{% if log_file.filename.endswith('.jsonl') %}info{% else %}secondary{% endif %}">
                                        {% if log_file.filename.endswith('.jsonl') %}JSONL{% else %}LOG{% endif %}
                                    </span>
                                </td>
                                <td>{{ (log_file.size / 1024)|round(2) }} KB</td>
                                <td>{{ log_file.modified }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewLog('{{ log_file.filename }}')">
                                        <i class="bi bi-eye"></i>
                                        æŸ¥çœ‹
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="downloadLog('{{ log_file.filename }}')">
                                        <i class="bi bi-download"></i>
                                        ä¸‹è½½
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-file-text text-muted" style="font-size: 4rem;"></i>
                    <h5 class="text-muted mt-3">æš‚æ— æ—¥å¿—æ–‡ä»¶</h5>
                    <p class="text-muted">æ‰§è¡Œä»»åŠ¡åå°†ç”Ÿæˆæ—¥å¿—æ–‡ä»¶</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- å®æ—¶æ—¥å¿— -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-activity"></i>
                    å®æ—¶æ—¥å¿—
                    <span class="badge bg-success ms-2" id="liveStatus">å®æ—¶</span>
                </h5>
            </div>
            <div class="card-body">
                <div id="liveLogs" class="bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: auto;">
                    <div class="text-muted">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="toggleLiveLogs()">
                        <i class="bi bi-pause" id="liveToggleIcon"></i>
                        <span id="liveToggleText">æš‚åœ</span>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm ms-2" onclick="clearLiveLogs()">
                        <i class="bi bi-trash"></i>
                        æ¸…ç©º
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°çš„å¼¹çª—ç³»ç»Ÿå°†é€šè¿‡ JavaScript åŠ¨æ€åˆ›å»º -->
{% endblock %}

{% block extra_js %}
<script>
    let liveLogsEnabled = true;
    let liveLogsInterval = null;
    let currentLogFile = null;

    // é¡µé¢åŠ è½½æ—¶å¯åŠ¨å®æ—¶æ—¥å¿—
    document.addEventListener('DOMContentLoaded', function() {
        startLiveLogs();
    });

    function startLiveLogs() {
        if (liveLogsInterval) {
            clearInterval(liveLogsInterval);
        }
        
        liveLogsInterval = setInterval(() => {
            if (liveLogsEnabled) {
                fetch('/api/execute/logs')
                    .then(response => response.json())
                    .then(data => {
                        updateLiveLogs(data.logs);
                    })
                    .catch(error => {
                        console.error('è·å–å®æ—¶æ—¥å¿—å¤±è´¥:', error);
                    });
            }
        }, 1000);
    }

    function updateLiveLogs(logs) {
        const container = document.getElementById('liveLogs');
        
        if (logs.length === 0) {
            container.innerHTML = '<div class="text-muted">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>';
            return;
        }
        
        const html = logs.map(log => {
            let className = 'text-light';
            if (log.includes('âœ…') || log.includes('æˆåŠŸ')) {
                className = 'text-success';
            } else if (log.includes('âŒ') || log.includes('å¤±è´¥') || log.includes('é”™è¯¯')) {
                className = 'text-danger';
            } else if (log.includes('âš ï¸') || log.includes('è­¦å‘Š')) {
                className = 'text-warning';
            } else if (log.includes('ğŸ”‘') || log.includes('Key')) {
                className = 'text-info';
            }
            
            return `<div class="${className}">${log}</div>`;
        }).join('');
        
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
    }

    function toggleLiveLogs() {
        liveLogsEnabled = !liveLogsEnabled;
        const icon = document.getElementById('liveToggleIcon');
        const text = document.getElementById('liveToggleText');
        const status = document.getElementById('liveStatus');
        
        if (liveLogsEnabled) {
            icon.className = 'bi bi-pause';
            text.textContent = 'æš‚åœ';
            status.textContent = 'å®æ—¶';
            status.className = 'badge bg-success ms-2';
        } else {
            icon.className = 'bi bi-play';
            text.textContent = 'ç»§ç»­';
            status.textContent = 'æš‚åœ';
            status.className = 'badge bg-warning ms-2';
        }
    }

    function clearLiveLogs() {
        document.getElementById('liveLogs').innerHTML = '<div class="text-muted">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>';
    }

    function viewLog(filename) {
        currentLogFile = filename;
        
        fetch(`/api/logs/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'danger');
                    return;
                }
                
                const content = document.getElementById('logContent');
                if (filename.endsWith('.jsonl')) {
                    // JSONL æ ¼å¼ç¾åŒ–æ˜¾ç¤º
                    const lines = data.content.split('\n').filter(line => line.trim());
                    const html = lines.map(line => {
                        try {
                            const json = JSON.parse(line);
                            return `<div class="mb-2"><pre class="mb-0">${JSON.stringify(json, null, 2)}</pre></div>`;
                        } catch (e) {
                            return `<div class="mb-2">${line}</div>`;
                        }
                    }).join('');
                    content.innerHTML = html;
                } else {
                    // æ™®é€šæ—¥å¿—æ ¼å¼
                    content.innerHTML = data.content.split('\n').map(line => 
                        `<div>${line}</div>`
                    ).join('');
                }
                
                const modalFooter = `
                    <button type="button" class="btn btn-secondary" onclick="customModal.close('logModal')">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="downloadCurrentLog()">
                        <i class="bi bi-download"></i>
                        ä¸‹è½½
                    </button>
                `;
                
                customModal.create('logModal', `æ—¥å¿—å†…å®¹: ${filename}`, content.outerHTML, modalFooter);
                customModal.open('logModal');
            })
            .catch(error => {
                showToast('è·å–æ—¥å¿—å†…å®¹å¤±è´¥: ' + error.message, 'danger');
            });
    }

    function downloadLog(filename) {
        const link = document.createElement('a');
        link.href = `/api/logs/${filename}`;
        link.download = filename;
        link.click();
    }

    function downloadCurrentLog() {
        if (currentLogFile) {
            downloadLog(currentLogFile);
            customModal.close('logModal');
        }
    }

    function refreshLogs() {
        location.reload();
    }

    function clearLogs() {
        confirmAction('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼', () => {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯ API æ¸…ç©ºæ—¥å¿—
            showToast('æ¸…ç©ºæ—¥å¿—åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ', 'info');
        });
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function() {
        if (liveLogsInterval) {
            clearInterval(liveLogsInterval);
        }
    });
</script>
{% endblock %}
